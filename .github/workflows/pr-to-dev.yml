name: ğŸ” PR to Dev - Build & Test

on:
  pull_request:
    branches: [ dev ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build & Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install Backend Dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: ğŸ“¦ Install Test Dependencies
      run: |
        cd tests
        pip install -r requirements.txt
    
    - name: ğŸ” Run Code Quality Checks
      run: |
        # Install linting tools
        pip install flake8 black isort
        
        # Check code formatting
        echo "ğŸ¨ Checking code formatting..."
        black --check backend/ tests/ || echo "âš ï¸ Code formatting issues found"
        
        # Check imports
        echo "ğŸ“¦ Checking import sorting..."
        isort --check-only backend/ tests/ || echo "âš ï¸ Import sorting issues found"
        
        # Run linting
        echo "ğŸ” Running linting..."
        flake8 backend/ tests/ --max-line-length=88 --ignore=E203,W503 || echo "âš ï¸ Linting issues found"
    
    - name: ğŸ§ª Run Unit Tests
      run: |
        cd tests
        python -m pytest test_unit.py -v --tb=short
    
    - name: ğŸ”— Run Integration Tests
      run: |
        cd tests
        python -m pytest test_integration.py -v --tb=short
    
    - name: ğŸ³ Build Docker Images
      run: |
        echo "ğŸ—ï¸ Building Docker images..."
        docker-compose build
    
    - name: ğŸš€ Test Docker Containers
      run: |
        echo "ğŸ³ Starting containers..."
        docker-compose up -d
        
        echo "â³ Waiting for containers to be ready..."
        sleep 30
        
        echo "ğŸ” Testing container health..."
        # Test backend health
        curl -f http://localhost:5001/health || exit 1
        
        # Test frontend health  
        curl -f http://localhost:8080/health || exit 1
        
        echo "âœ… All containers are healthy!"
        
        # Cleanup
        docker-compose down
    
    - name: ğŸ“Š Generate Test Report
      if: always()
      run: |
        echo "## ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Unit Tests: Completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Integration Tests: Completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker Build: Completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Container Health: Verified" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‰ **Ready for manual merge to dev branch!**" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ” Run Security Scan
      run: |
        pip install safety bandit
        
        echo "ğŸ” Scanning dependencies for vulnerabilities..."
        cd backend && safety check -r requirements.txt || echo "âš ï¸ Security vulnerabilities found"
        
        echo "ğŸ” Scanning code for security issues..."
        bandit -r backend/ -f json || echo "âš ï¸ Security issues found"
    
    - name: ğŸ³ Scan Docker Images
      run: |
        echo "ğŸ” Scanning Docker images..."
        docker-compose build
        
        # Install trivy for container scanning
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
        # Scan images
        trivy image --exit-code 0 --severity HIGH,CRITICAL projet-backend || echo "âš ï¸ Backend image vulnerabilities found"
        trivy image --exit-code 0 --severity HIGH,CRITICAL projet-frontend || echo "âš ï¸ Frontend image vulnerabilities found" 