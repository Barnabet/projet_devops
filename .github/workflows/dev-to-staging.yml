name: ðŸš€ Dev to Staging - Auto Promote

on:
  push:
    branches: [ dev ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  PYTHON_VERSION: '3.9'

jobs:
  promote-to-staging:
    name: ðŸŽ¯ Promote to Staging
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ”§ Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: ðŸš€ Push to Staging Branch
      run: |
        echo "ðŸŽ¯ Promoting dev branch to staging..."
        
        # Check if staging branch exists
        if git show-ref --verify --quiet refs/remotes/origin/staging; then
          echo "ðŸ“¦ Staging branch exists, updating..."
          git checkout staging
          git pull origin staging
          git merge origin/dev --no-ff -m "chore: promote dev to staging - $(date)"
        else
          echo "ðŸ†• Creating staging branch from dev..."
          git checkout -b staging
        fi
        
        # Push to staging
        git push origin staging
        
        echo "âœ… Successfully promoted to staging branch!"
    
    - name: ðŸ“Š Generate Promotion Report
      run: |
        echo "## ðŸš€ Promotion Report" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Source**: dev branch" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Target**: staging branch" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Status**: Successfully promoted" >> $GITHUB_STEP_SUMMARY
        echo "- â³ **Next**: Staging tests will run automatically" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Dev changes are now in staging for testing!**" >> $GITHUB_STEP_SUMMARY

  notify-staging:
    name: ðŸ“¢ Notify Staging Deployment
    runs-on: ubuntu-latest
    needs: promote-to-staging
    
    steps:
    - name: ðŸ“¢ Create Staging Notification
      run: |
        echo "ðŸŽ¯ Staging deployment initiated"
        echo "The staging branch has been updated and will trigger comprehensive testing." 